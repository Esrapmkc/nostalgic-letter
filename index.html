<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>>Nostalgic Letter</title>
  <link rel="icon" type="image/png" href="favicon.png">


  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=EB+Garamond:wght@400;500&display=swap" rel="stylesheet">

  <!-- Preload (helps first load feel faster) -->
  <link rel="preload" href="mektup1.svg" as="image" type="image/svg+xml">
  <link rel="preload" href="mektup2.svg" as="image" type="image/svg+xml">
  <link rel="preload" href="yirtilma.mp3" as="audio" type="audio/mpeg">
  <link rel="preload" href="kagit.mp3" as="audio" type="audio/mpeg">

  <style>
    :root{
      --burgundy-1:#1a0208;
      --burgundy-2:#3a0a16;
      --burgundy-3:#120107;

      --gold-1: rgba(255, 215, 130, 0.18);
      --gold-2: rgba(255, 210, 110, 0.10);
      --gold-3: rgba(255, 240, 190, 0.08);

      /* Invisible text frame on the 2nd letter image */
      --frame-top: 52%;
      --frame-left: 50%;
      --frame-width: min(74%, 380px);
      --frame-height: 44%;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; color:#f2e9e9; font-family:"EB Garamond", serif; overflow-x:hidden; }

    .stage{
      min-height:100vh; display:grid; place-items:center; padding:24px 16px; position:relative;
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(255, 220, 150, 0.06), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, rgba(255, 205, 120, 0.05), transparent 60%),
        radial-gradient(900px 900px at 40% 85%, rgba(255, 210, 130, 0.04), transparent 60%),
        linear-gradient(160deg, var(--burgundy-1), var(--burgundy-2) 55%, var(--burgundy-3));
    }

    .sparkles{
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(circle at 12% 18%, var(--gold-1) 0 2px, transparent 3px),
        radial-gradient(circle at 22% 62%, var(--gold-2) 0 1.5px, transparent 3px),
        radial-gradient(circle at 31% 35%, var(--gold-3) 0 1.2px, transparent 3px),
        radial-gradient(circle at 48% 22%, var(--gold-2) 0 1.4px, transparent 3px),
        radial-gradient(circle at 63% 58%, var(--gold-1) 0 2px, transparent 3px),
        radial-gradient(circle at 74% 28%, var(--gold-3) 0 1.2px, transparent 3px),
        radial-gradient(circle at 86% 66%, var(--gold-2) 0 1.6px, transparent 3px),
        radial-gradient(circle at 92% 18%, var(--gold-1) 0 1.8px, transparent 3px);
      opacity:0.85; animation: twinkle 3.8s ease-in-out infinite;
      filter: blur(0.1px);
    }
    @keyframes twinkle{ 0%,100%{opacity:0.55} 50%{opacity:0.95} }

    .card{ width:min(520px, 100%); position:relative; }

    .hint{
      text-align:center; font-size:16px; margin-bottom:10px; opacity:0.92;
      text-shadow:0 2px 12px rgba(0,0,0,0.35);
    }

    .scene{
      width:100%; border:0; padding:0; background:transparent; cursor:pointer;
      position:relative; display:block; touch-action:manipulation;
    }

    .letter{
      width:100%; height:auto; display:block; user-select:none; -webkit-user-drag:none;
      border-radius:16px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.45), 0 2px 10px rgba(0,0,0,0.25);
      background: rgba(255,255,255,0.02);
    }

    .reveal{
      position:absolute; inset:0; display:grid; place-items:center;
      opacity:0; transform: translateY(10px) scale(0.985);
      pointer-events:none;
    }
    .reveal.is-on{
      opacity:1; transform: translateY(0) scale(1);
      transition: opacity 520ms ease, transform 520ms ease;
      pointer-events:auto;
    }

    .letter--front{ transition: opacity 420ms ease, transform 420ms ease; }
    .letter--front.is-off{ opacity:0; transform: translateY(8px) scale(0.99); }

    /* Invisible text frame (no box shown) */
    .msg-frame{
      position:absolute;
      top: var(--frame-top);
      left: var(--frame-left);
      transform: translate(-50%, -50%);
      width: var(--frame-width);
      height: var(--frame-height);
      overflow:hidden;
      pointer-events:none;
    }

    .message{
      font-family:"Marck Script", cursive;
      font-size: clamp(16px, 4.2vw, 28px);
      line-height: 1.18;
      color: rgba(60, 30, 18, 0.86);
      text-shadow: 0 1px 0 rgba(255,255,255,0.10), 0 10px 24px rgba(0,0,0,0.14);
      mix-blend-mode: multiply;
      filter: saturate(1.05) contrast(1.02);
      text-align:left;
      padding: 2px 2px;
    }
    .message p{ margin: 0 0 10px 0; }
    .message p:last-child{ margin-bottom:0; }

    .page-indicator{
      position:absolute;
      top: calc(var(--frame-top) + (var(--frame-height) / 2) + 14px);
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      color: rgba(60,30,18,0.55);
      font-family: "EB Garamond", serif;
      user-select:none;
      pointer-events:none;
    }

    .footer{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
    .mini{
      border:1px solid rgba(255, 220, 150, 0.22);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.88);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-size:14px;
      backdrop-filter: blur(6px);
    }
    .mini:active{transform: translateY(1px)}
    .mini:disabled{ opacity:0.55; cursor:default; }

    .loading{
      text-align:center;
      font-size:13px;
      opacity:0.75;
      margin-top:8px;
      display:none;
    }
    .loading.on{ display:block; }
  </style>
</head>

<body>
  <main class="stage">
    <div class="sparkles" aria-hidden="true"></div>

    <section class="card" role="application">
      <div class="hint" id="hint">Tap the letter ✨</div>

      <button class="scene" id="scene" aria-label="Open the letter">
        <img id="img1" class="letter letter--front" src="mektup1.svg" alt="Closed letter" draggable="false" />

        <div id="reveal" class="reveal" aria-hidden="true">
          <img id="img2" class="letter letter--back" src="mektup2.svg" alt="Opened letter" draggable="false" />

          <div class="msg-frame" id="msgFrame">
            <div class="message" id="message" aria-live="polite"></div>
          </div>

          <div class="page-indicator" id="pageIndicator"></div>
        </div>
      </button>

      <div class="footer">
        <button class="mini" id="nextPage" type="button">Next</button>
        <button class="mini" id="replay" type="button">Replay</button>
      </div>

      <div class="loading" id="loading">Loading assets…</div>

      <audio id="sndRip" preload="auto" src="yirtilma.mp3"></audio>
      <audio id="sndPaper" preload="auto" src="kagit.mp3"></audio>
    </section>
  </main>

  <script>
    // ✅ Apps Script Web App endpoint
    const APPS_SCRIPT_ENDPOINT =
      "https://script.google.com/macros/s/AKfycbzoIszB1N13oP8YDQkcjQaw8tMxi5mQ8CTZUyweYMc5zsqsrzp2pscER39g-WNjuvNemw/exec";

    // DOM
    const scene = document.getElementById("scene");
    const hint = document.getElementById("hint");
    const loading = document.getElementById("loading");

    const img1 = document.getElementById("img1");
    const reveal = document.getElementById("reveal");

    const msgFrame = document.getElementById("msgFrame");
    const msgEl = document.getElementById("message");
    const pageIndicator = document.getElementById("pageIndicator");

    const sndRip = document.getElementById("sndRip");
    const sndPaper = document.getElementById("sndPaper");

    const btnNext = document.getElementById("nextPage");
    const btnReplay = document.getElementById("replay");

    let opened = false;

    // Fallback (when no id=... in URL, or invalid id)
    const DEFAULT_LETTER_TEXT = `
Your message will appear here…
    `.trim();

    // Will be replaced by Sheet message if id is valid
    let LETTER_TEXT = DEFAULT_LETTER_TEXT;

    // -------------------------
    // Helpers
    // -------------------------
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, (m) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#39;",
      }[m]));
    }

    function splitParagraphs(text) {
      return text
        .split(/\n\s*\n/g)
        .map((p) => p.replace(/\s+/g, " ").trim())
        .filter(Boolean);
    }

    function renderParagraphs(paras) {
      msgEl.innerHTML = paras.map((p) => `<p>${escapeHTML(p)}</p>`).join("");
    }

    function paginateToFit(paragraphs) {
      const pages = [];
      let current = [];

      const fits = (paras) => {
        renderParagraphs(paras);
        return msgEl.scrollHeight <= msgFrame.clientHeight + 1;
      };

      const splitIntoSentences = (para) => {
        const parts = para
          .split(/(?<=[.!?…])\s+/)
          .map((s) => s.trim())
          .filter(Boolean);
        return parts.length ? parts : [para];
      };

      for (const para of paragraphs) {
        const candidate = [...current, para];
        if (fits(candidate)) {
          current = candidate;
          continue;
        }

        if (current.length) pages.push(current);

        current = [];
        if (fits([para])) {
          current = [para];
          continue;
        }

        const sentences = splitIntoSentences(para);
        let temp = [];
        for (const s of sentences) {
          const cand2 = [...temp, s];
          if (fits(cand2)) temp = cand2;
          else {
            if (temp.length) pages.push(temp);
            temp = [s];
          }
        }
        current = temp;
      }

      if (current.length) pages.push(current);
      return pages;
    }

    // -------------------------
    // Sound
    // -------------------------
    function hardStop(a) { try { a.pause(); a.currentTime = 0; } catch {} }

    function playRipThenPaper() {
      hardStop(sndRip);
      hardStop(sndPaper);
      sndRip.volume = 1.0;
      sndPaper.volume = 0.95;

      const ripPlay = sndRip.play();
      if (ripPlay && typeof ripPlay.catch === "function") ripPlay.catch(() => {});

      let paperStarted = false;
      const startPaper = () => {
        if (paperStarted) return;
        paperStarted = true;

        const p = sndPaper.play();
        if (p && typeof p.catch === "function") p.catch(() => {});

        // stop after ~1.8s
        setTimeout(() => { try { sndPaper.pause(); } catch {} }, 1800);
      };

      sndRip.onended = startPaper;
      setTimeout(startPaper, 350);
    }

    // Page turn sound: play ONLY from 2.0s to 3.0s
    async function playPaperSegment(startSec = 2.0, endSec = 3.0) {
      hardStop(sndPaper);
      sndPaper.volume = 0.95;

      const ensureSeekable = () =>
        new Promise((resolve) => {
          if (sndPaper.readyState >= 2) return resolve();
          sndPaper.addEventListener("canplay", () => resolve(), { once: true });
          try { sndPaper.load(); } catch {}
        });

      await ensureSeekable();

      try { sndPaper.currentTime = startSec; } catch {}

      const p = sndPaper.play();
      if (p && typeof p.catch === "function") p.catch(() => {});

      const ms = Math.max(0, (endSec - startSec) * 1000);
      setTimeout(() => { try { sndPaper.pause(); } catch {} }, ms);
    }

    // -------------------------
    // Paging
    // -------------------------
    let pages = [];
    let pageIndex = 0;

    function renderPage() {
      const total = pages.length;
      const paras = pages[pageIndex] || [];
      renderParagraphs(paras);

      if (total <= 1) {
        pageIndicator.textContent = "";
        btnNext.textContent = "Finished";
        btnNext.disabled = true;
        return;
      }

      pageIndicator.textContent = `${pageIndex + 1} / ${total}`;
      const isLast = pageIndex >= total - 1;
      btnNext.textContent = isLast ? "Finished" : "Next";
      btnNext.disabled = isLast;
    }

    function buildPagesAndShowFirst() {
      const paragraphs = splitParagraphs(LETTER_TEXT);
      pages = paginateToFit(paragraphs);
      pageIndex = 0;
      renderPage();
    }

    function openLetter() {
      if (opened) return;
      opened = true;

      hint.textContent = "✨";
      playRipThenPaper();

      setTimeout(() => {
        img1.classList.add("is-off");
        reveal.classList.add("is-on");
        reveal.setAttribute("aria-hidden", "false");

        requestAnimationFrame(() => {
          buildPagesAndShowFirst();
        });
      }, 420);
    }

    function nextPage() {
      if (!opened) return;
      const isLast = pageIndex >= pages.length - 1;
      if (isLast) return;

      playPaperSegment(2.0, 3.0);

      pageIndex += 1;
      renderPage();
    }

    function resetAll() {
      opened = false;
      hint.textContent = "Tap the letter ✨";
      img1.classList.remove("is-off");
      reveal.classList.remove("is-on");
      reveal.setAttribute("aria-hidden", "true");
      pageIndicator.textContent = "";
      msgEl.innerHTML = "";
      btnNext.textContent = "Next";
      btnNext.disabled = false;
      sndRip.onended = null;
      hardStop(sndRip);
      hardStop(sndPaper);

      // if user replays, rebuild pages from current LETTER_TEXT
      pages = [];
      pageIndex = 0;
    }

    // -------------------------
    // Load message from Sheet (JSONP)
    // -------------------------
    function getIdFromURL() {
      return new URLSearchParams(location.search).get("id") || "";
    }

    // JSONP callback MUST be global
    window.handleLetterData = function (data) {
      if (!data || !data.ok) {
        hint.textContent = "This link is invalid or expired.";
        LETTER_TEXT = DEFAULT_LETTER_TEXT;
        return;
      }

      LETTER_TEXT = (data.message || DEFAULT_LETTER_TEXT).trim();
      hint.textContent = "Tap the letter ✨";
    };

    function loadMessageFromSheet() {
      const id = getIdFromURL().trim();
      if (!id) return;

      hint.textContent = "Loading your letter…";
      const s = document.createElement("script");
      s.src = `${APPS_SCRIPT_ENDPOINT}?id=${encodeURIComponent(id)}&callback=handleLetterData`;
      s.async = true;
      document.head.appendChild(s);
    }

    // -------------------------
    // Warm-up assets
    // -------------------------
    async function warmUpAssets() {
      loading.classList.add("on");
      const urls = ["mektup1.svg", "mektup2.svg", "yirtilma.mp3", "kagit.mp3"];

      await Promise.allSettled(urls.map((u) => fetch(u, { cache: "force-cache" })));

      const imgA = new Image(); imgA.src = "mektup1.svg";
      const imgB = new Image(); imgB.src = "mektup2.svg";
      await Promise.allSettled([
        imgA.decode?.() ?? Promise.resolve(),
        imgB.decode?.() ?? Promise.resolve(),
      ]);

      try { sndRip.load(); sndPaper.load(); } catch {}
      loading.classList.remove("on");
    }

    // -------------------------
    // Init
    // -------------------------
    scene.addEventListener("click", openLetter);
    btnNext.addEventListener("click", (e) => { e.stopPropagation(); nextPage(); });
    btnReplay.addEventListener("click", (e) => { e.stopPropagation(); resetAll(); });

    warmUpAssets();
    loadMessageFromSheet();
  </script>
</body>
</html>
